---
layout: post
title: æ·˜å®ç›´æ’­å¼¹å¹•çˆ¬è™«
key: 20171209
tags: crawler node.js
---

## èƒŒæ™¯è¯´æ˜
å…¬å¸æœ‰é€šè¿‡æ·˜å®ç›´æ’­é—´çŸ­é“¾æ¥æ¥çˆ¬å–ç›´æ’­å¼¹å¹•çš„éœ€æ±‚, å¥ˆä½•å³ä¾¿googleä¸Šé¢ä¹Ÿä»…æ‰¾åˆ°ä¸€ä¸ªç›¸å…³çš„è¯é¢˜, è¿˜æ²¡æœ‰ç­”æ¡ˆ. æ‰€ä»¥åªèƒ½è‡ªé£Ÿå…¶åŠ›äº†.

çˆ¬è™«çš„githubä»“åº“åœ°å€åœ¨æ–‡æœ«, æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹çˆ¬è™«çš„æœ€ç»ˆæ•ˆæœ:
![](/assets/posts/20171209/overview.png)

ä¸‹é¢æˆ‘ä»¬æ¥æŠ½ä¸å‰¥èŒ§, é‡ç°ä¸€ä¸‹è°ƒç ”è¿‡ç¨‹.

## é¡µé¢åˆ†æ
ç›´æ’­é—´åœ°å€åœ¨åˆ†äº«ç›´æ’­æ—¶å¯ä»¥æ‹¿åˆ°:
![](/assets/posts/20171209/address.png)

å¼¹å¹•ä¸€èˆ¬ä¸æ˜¯websocketå°±æ˜¯socket. æˆ‘ä»¬æ‰“å¼€dev toolsè¿‡æ»¤wsçš„è¯·æ±‚å³å¯çœ‹åˆ°websocketåœ°å€:
![](/assets/posts/20171209/wsurl.png)

> æä¸€ä¸‹æ–—é±¼: å®ƒèµ°çš„æ˜¯flashçš„socket, æˆ‘ä»¬å°±ç®—æ‰“å¼€dev toolsä¹Ÿæ˜¯æ‡µé€¼, å¥½åœ¨æ–—é±¼å®˜æ–¹ç›´æ¥å¼€æ”¾äº†socketçš„API.

æˆ‘ä»¬ç»§ç»­æŸ¥çœ‹æ”¶åˆ°çš„æ¶ˆæ¯, å‘ç°æ¶ˆæ¯çš„å‹ç¼©ç±»å‹compressTypeæœ‰ä¸¤ç§: COMMONå’ŒGZIP. dataçš„å€¼è‚¯å®šå°±æ˜¯ç›®æ ‡æ¶ˆæ¯äº†, çœ‹èµ·æ¥åƒç»è¿‡äº†base64ç¼–ç , è§£å¯†è¿‡ç¨‹åé¢å†è¯´.
![](/assets/posts/20171209/frames.png)

ç°åœ¨æˆ‘ä»¬é¦–å…ˆè¦è§£å†³çš„é—®é¢˜æ˜¯å¦‚ä½•æ‹¿åˆ°websocketåœ°å€. åˆ†æä¸€ä¸‹html source, å‘ç°å¯ä»¥é€šè¿‡å…¶ä¸­ä¸å˜çš„éƒ¨åˆ†æŸ¥æ‰¾åˆ°è„šæœ¬:
![](/assets/posts/20171209/source.png)
ç„¶é¹…, æ‹¿åˆ°è¿™å—æ•´ä¸ªçš„è„šæœ¬æ ¼å¼åŒ–ä¹‹åå‘ç°, åŸå§‹ä»£ç æ˜æ˜¾æ˜¯æ¨¡å—åŒ–å¼€å‘çš„, ç»è¿‡äº†æ‰“åŒ…å‹ç¼©. æ‰€ä»¥æˆ‘ä»¬åªèƒ½åˆ†ææ¨¡å—å†…ä¸€å°å—ä»£ç , è¿™æ˜¯æ²¡æœ‰æ„ä¹‰çš„.

ä½†æ˜¯æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°ä¸åŒçš„ç›´æ’­é—´websocketåœ°å€å”¯ä¸€ä¸åŒçš„åªæœ‰token, æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æƒ³åŠæ³•æ‹¿åˆ°token. å½“ç„¶è¿™æ˜¯å¾ˆæ¶å¿ƒçš„ç¯èŠ‚, å®Œå…¨æ²¡æœ‰å¤´ç»ª, æƒ³åˆ°çš„å„ç§å¯èƒ½æ€§éƒ½å¤±è´¥äº†. åé¢åƒæ— å¤´è‹è‡ä¸€æ ·çœ‹é¡µé¢å‘èµ·çš„è¯·æ±‚, ç«Ÿç„¶ç»™æ‰¾åˆ°äº†...  
tokenæ˜¯é€šè¿‡apiè¯·æ±‚è·å–çš„, apiåœ°å€æ˜¯:

```
http://h5api.m.taobao.com/h5/mtop.mediaplatform.live.encryption/1.0/
```
![](/assets/posts/20171209/api.png)

å¥½äº†é‚£websocketåœ°å€çš„é—®é¢˜è§£å†³äº†, æˆ‘ä»¬å¼€å§‹å†™çˆ¬è™«å§.

## ç¼–å†™çˆ¬è™«
çœ‹çœ‹apiçš„query stringé‚£ä¸€å †åŠ¨æ€å‚æ•°, æ™®é€šçˆ¬è™«å°±åˆ«æƒ³äº†, æˆ‘ä»¬ç¥­å‡ºç¥å™¨: [puppeteer][puppeteer].

puppeteeræ˜¯è°·æ­Œæ¨å‡ºçš„å¼€æ”¾Node APIçš„æ— å¤´æµè§ˆå™¨, ç†è®ºä¸Šå¯ä»¥å¯ç¼–ç¨‹åŒ–åœ°æ§åˆ¶æµè§ˆå™¨çš„å„ç§è¡Œä¸º, å¯¹äºæˆ‘ä»¬çš„åœºæ™¯æ¥è¯´å°±æ˜¯:
ç›´æ’­é¡µé¢åŠ è½½å®Œä¹‹å, æ‹¦æˆªè·å–websocket tokençš„apiè¯·æ±‚, è§£æç»“æœæ‹¿åˆ°token. è¿™éƒ¨åˆ†çš„ä»£ç å¦‚ä¸‹:

```js
    const browser = await puppeteer.launch()
    const page = (await browser.pages())[0]
    await page.setRequestInterception(true)
    const api = 'http://h5api.m.taobao.com/h5/mtop.mediaplatform.live.encryption/1.0/'
    const { url } = message

    // intercept request obtaining the web socket token
    page.on('request', req => {
        if (req.url.includes(api)) {
            console.log(`[${url}] getting token`)
        }
        req.continue()
    })
    page.on('response', async res => {
        if (!res.url.includes(api)) return

        const data = await res.text()
        const token = data.match(/"result":"(.*?)"/)[1]
        const url = `ws://acs.m.taobao.com/accs/auth?token=${token}`
    })

    // open the taobao live page
    await page.goto(url, { timeout: 0 })
    console.log(`[${url}] page loaded`)
```

> è¿™é‡Œæœ‰ä¸ªæ€§èƒ½ä¼˜åŒ–çš„å°æŠ€å·§. puppeteerå®˜æ–¹ç¤ºä¾‹ä¸­è·å–pageå®ä¾‹ä¼šæ‰“å¼€ä¸€ä¸ªæ–°é¡µé¢: `const page = await browser.newPage()`, å®é™…ä¸Šæµè§ˆå™¨å¯åŠ¨æœ¬æ¥å°±é»˜è®¤æœ‰ä¸ªabout:blanké¡µé¢æ‰“å¼€, æˆ‘ä»¬çš„ä»£ç ä¸­ç›´æ¥æ˜¯è·å–è¿™ä¸ªæ‰“å¼€çš„å®ä¾‹æ¥è·³è½¬ç›´æ’­é¡µé¢, è¿™æ ·å°±å¯ä»¥å°‘ä¸€ä¸ªè¿›ç¨‹.  
å¯ä»¥ps ax|grep puppeteerè§‚å¯Ÿå¯åŠ¨çš„è¿›ç¨‹æ•°æ¥è¿›è¡Œå¯¹æ¯”, é»˜è®¤æœ‰ä¸¤ä¸ªä¸»è¿›ç¨‹, å‰©ä½™çš„éƒ½æ˜¯é¡µé¢è¿›ç¨‹.

è·å–åˆ°websocketåœ°å€å°±å¯ä»¥å»ºç«‹è¿æ¥æ‹‰å–æ¶ˆæ¯äº†:

```js
    const url = `ws://acs.m.taobao.com/accs/auth?token=${token}`
    const ws = new WebSocket(url)

    ws.on('open', () => {
        console.log(`\nOPEN:  ${url}\n`)
    })
    ws.on('close', () => {
        console.log('DISCONN')
    })
    ws.on('message', msg => {
        console.log(msg)
    })
```
![](/assets/posts/20171209/rawmsgs.png)

## æ¶ˆæ¯è§£å¯†
ç°åœ¨æˆ‘ä»¬èƒ½æŒç»­æ‹‰å–æ¶ˆæ¯äº†, è¿™æ ·ä¼šæ–¹ä¾¿åˆ†æ. å‰é¢æˆ‘ä»¬åˆ†æé¡µé¢çš„æ—¶å€™å‘ç°compressTypeæœ‰ä¸¤ç§: COMMONå’ŒGZIP. ç»è¿‡å°è¯•, COMMONçš„å¯ä»¥ç›´æ¥å¾—åˆ°æ˜æ–‡, è€ŒGZIPçš„éœ€è¦å†ç»è¿‡ä¸€æ¬¡gunzipè§£ç . è§£ç ç»“æœå¤§è‡´å¦‚ä¸‹, é‡Œé¢å·²ç»å¯ä»¥çœ‹åˆ°æ˜µç§°å’Œå¼¹å¹•å†…å®¹äº†:
![](/assets/posts/20171209/plainmsg.png)

ç„¶é¹…, ä¸€åˆ‡æ‰åˆšåˆšå¼€å§‹...å†…å®¹é‡Œé¢æ˜¯æœ‰ä¹±ç çš„, åŸºäºè¿™æ ·çš„å†…å®¹åšæ­£åˆ™åŒ¹é…æ— æœ. å¦‚æœå°è¯•ç›´æ¥ä¿å­˜`buffer`æˆ–è€…`buffer.toString()`åˆ°æ–‡ä»¶ä¼šå‘ç°æ–‡ä»¶æ ¹æœ¬æ‰“ä¸å¼€, å†…å®¹æ˜¯æ— æ³•è§£æçš„:
![](/assets/posts/20171209/invalid.png)

æ²¡åŠæ³•, æˆ‘ä»¬åªèƒ½åˆ†æåŸå§‹buffer arrayçš„utf8ç¼–ç äº†. è¿™é‡Œå¼€äº†è„‘æ´, ç›´æ¥å°†buffer arrayåšjoinå¾—åˆ°çš„stringæ‹¿æ¥åˆ†æå…¶è§„å¾‹ (åˆ†æä»£ç è§analyze.jsæ–‡ä»¶):
![](/assets/posts/20171209/analyze.png)

å‡ ä¸ªæ ·æœ¬çš„åˆ†æç»“æœå¦‚ä¸‹, å…¶ä¸­ä¸å˜çš„éƒ¨åˆ†åšäº†é«˜äº®:
![](/assets/posts/20171209/rule.png)

> è¿™äº›å€¼å¯èƒ½æ˜¯ç”±æœ‰æ•ˆå­—ç¬¦ç¼–ç æŒ‰ä¸€å®šè§„åˆ™æ¢ç®—è¿‡æ¥, ä½†è°åˆèƒ½çŒœå¾—åˆ°å‘¢, ä¹Ÿæ²¡å¿…è¦.

è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼è§£æå‡ºnickå’Œbarrageäº†:

```js
/.*,[0-9]+,0,18,[0-9]+,(.*?),32,[0-9]+,[0-9]+,[0-9]+,[0-9]+,[0-9]+,44,50,2,116,98,[0-9]+,0,10,[0-9]+,(.*?),18,20,10,12/
```

å½“ç„¶è¿™ä¸ªpatternåŒæ ·èƒ½åŒ¹é…åˆ°å…³æ³¨ä¸»æ’­çš„å¼¹å¹•, è¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„. æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸²ç¡®å®šçš„bufferå­—ç¬¦ä¸²æå‰è¿‡æ»¤æ‰è¿™ç§æ¶ˆæ¯:

```js
const followedPattern = '226,129,130,226,136,176,226,143,135,102,111,108,108,111,119'
```
è‡³æ­¤æˆ‘ä»¬å·²ç»å¯ä»¥è§£æå‡ºå¹²å¹²å‡€å‡€çš„æ˜µç§°+å¼¹å¹•äº†. å®Œæ•´è§£å¯†ä»£ç å¦‚ä¸‹:

```js
function decode(msg) {
    // base64 decode
    let buffer = Buffer.from(msg.data, 'base64')
    if (msg.compressType === 'GZIP') {
        // gzip decode
        buffer = zlib.gunzipSync(buffer)
    }
    const bufferStr = buffer.join(',')

    // [followed] notifications are ignored
    const followedPattern = '226,129,130,226,136,176,226,143,135,102,111,108,108,111,119'
    if (bufferStr.includes(followedPattern)) {
        return
    }

    // // print for debugging
    // console.log(bufferStr)
    // console.log(buffer.toString())

    // first match is nick name and second match is barrage content
    const barragePattern = /.*,[0-9]+,0,18,[0-9]+,(.*?),32,[0-9]+,[0-9]+,[0-9]+,[0-9]+,[0-9]+,44,50,2,116,98,[0-9]+,0,10,[0-9]+,(.*?),18,20,10,12/
    const matched = bufferStr.match(barragePattern)
    if (matched) {
        const nick = parseStr(matched[1])
        const barrage = parseStr(matched[2])
        console.log(`${nick}:  ${barrage}`)
    }
}
```

å½“ç„¶å¯èƒ½è¿˜å­˜åœ¨ä¸€ä¸ªé—®é¢˜, æ˜¯å…³äºä¸Šé¢åˆ†æç»“æœè¡¨é‡Œçš„`barrageå‰`, æœ‰è¿ç»­çš„5ä½å›ºå®šä¸å˜, å®é™…ä¸Šåˆšå¼€å§‹æ˜¯è¿åŒå‰é¢ä¸€ä½å…±6ä½ä¸å˜çš„, ç»“æœè¿‡äº†ä¸€å¤©ä¹‹åå‰é¢é‚£ä½ä»130å˜åˆ°äº†131, è€Œå†å¾€å‰çš„å‡ ä½å˜åŒ–é¢‘ç‡åˆ™ç‰¹åˆ«é«˜. æ‰€ä»¥æˆ‘æ€€ç–‘è¿™äº›å€¼æœ‰å¯èƒ½æ˜¯è·Ÿå½“å‰æ—¶é—´æœ‰å…³.  
å¯èƒ½ä¸ç¡®å®šçš„ä¸€æ®µæ—¶é—´ä¹‹åè¿™5ä½å›ºå®šå€¼ä¹Ÿä¼šå˜æ‰å§, åˆ°æ—¶æ­£åˆ™å°±å¾—è°ƒæ•´äº†, ä½†åº”è¯¥å¯ä»¥æ­£å¸¸è¿è¡Œå¾ˆä¹…äº†. å¦‚æœ‰å“ªäº›åŒä»æ„Ÿå…´è¶£, å¯ä»¥æ‰¾æ‰¾è§„å¾‹.

## è¿›ç¨‹ç»´æŠ¤
å®é™…ä½¿ç”¨æ—¶æµç¨‹å¤§è‡´åº”è¯¥æ˜¯è¿™æ ·çš„: æ”¶åˆ°è¯·æ±‚ä¹‹åä¸»è¿›ç¨‹forkä¸€ä¸ªçˆ¬è™«å­è¿›ç¨‹æ¥è·å–websocket url, å­è¿›ç¨‹è¿”å›ç»“æœç»™ä¸»è¿›ç¨‹, åœ¨ä½¿ç”¨æ–¹å»ºç«‹websocketè¿æ¥(æŠ¢è¿‡è¿æ¥)ä¹‹å, å­è¿›ç¨‹ä¾¿å¯è‡ªæ€é‡Šæ”¾èµ„æº, è‡ªæ€çš„åŒæ—¶`browser.close()`æ€æ­»puppeteerç›¸å…³è¿›ç¨‹.  
ä¹‹æ‰€ä»¥è¿™æ ·åšæ˜¯å› ä¸ºæµ‹è¯•ä¸‹æ¥: websocketæ–­å¼€è¿æ¥ä¸ä¹…tokenä¼šå¤±æ•ˆ.

## Githubä»“åº“
è®°å¾—starå•ŠğŸ˜‰  
[https://github.com/xiaozhongliu/taobao-live-crawler](https://github.com/xiaozhongliu/taobao-live-crawler)





[puppeteer]: https://github.com/GoogleChrome/puppeteer
